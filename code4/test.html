
<!doctype html>
<head>
<script src="gl_lib3.js"></script>
</head>
<body>
<canvas id="canvas1" width="640" height="640"></canvas>
<script>
function normalize(v) {
   var s = Math.sqrt(v[0]*v[0] + v[1]*v[1] + v[2]*v[2] + v[3]*v[3]  );
   v[0] /= s;
   v[1] /= s;
   v[2] /= s;
   v[3] /= s;
   return v;
}

// INFO ABOUT SHADING THE SURFACE. NOTE THAT SPECULAR REMAINS UNIMPLEMENTED.

var ambient = [0.1, 0.1, 0];
var diffuse = [0.9, 0.9, 0];

// DIRECTION AND COLOR FOR EACH LIGHT SOURCE.

var lightDir = [[1, 0, 0], [-1,1,-1]];
var lightRGB = [[1, 1, 1], [.8,.0,.0]];

// MAKE SURE ALL LIGHT DIRECTIONS ARE UNIT LENGTH.

for (var n = 0 ; n < lightDir.length; n++)
   lightDir[n] = normalize(lightDir[n]);

// INITIALIZE MY UNIFORM SHADER VARIABLES.

var initialize_gl = function(gl) {
   gl.u_ambient = gl.getUniformLocation(gl.prog, "u_ambient");
   gl.u_diffuse = gl.getUniformLocation(gl.prog, "u_diffuse");
   gl.u_lightDir = gl.getUniformLocation(gl.prog, "u_lightDir");
   gl.u_lightRGB = gl.getUniformLocation(gl.prog, "u_lightRGB");
};

// AT EACH ANIMATION FRAME, UPDATE THE VALUES OF MY UNIFORM SHADER VARIABLES.

var update_gl = function(gl) {
   gl.uniform3f(gl.u_ambient, ambient[0], ambient[1], ambient[2]);
   gl.uniform3f(gl.u_diffuse, diffuse[0], diffuse[1], diffuse[2]);

   var L = [];
   for (var n = 0 ; n < lightDir.length ; n++)
      L = L.concat(lightDir[n]);

   gl.uniform3fv(gl.u_lightDir, new Float32Array(L));

   var L = [];
   for (var n = 0 ; n < lightRGB.length ; n++)
      L = L.concat(lightRGB[n]);

   gl.uniform3fv(gl.u_lightRGB, new Float32Array(L));
}

// THE VERTEX SHADER RUNS ONCE PER TRIANGLE VERTEX.

var vertexShader = [
,'    attribute vec3 a_pos;'
,'    varying   vec3 v_pos;'
,'    void main() {'
,'        gl_Position = vec4(a_pos, 1.0);'
,'        v_pos = a_pos;'
,'    }'
].join('\n\ ');

var fragmentShader = [
,'    precision mediump float;'
,'    uniform float u_pixelSize;'
,'    uniform float u_time;'
,'    uniform vec3  u_ambient;'
,'    uniform vec3  u_diffuse;'
,'    uniform vec3  u_lightDir[2];'
,'    uniform vec3  u_lightRGB[2];'
,'    uniform vec3  u_mouse;'
,'    varying vec3  v_pos;'
,'    vec3 color = vec3(0., 0., 0.);'
,'    '
,'    vec4 create_sphere(float x, float y, float z, float r){'
,'        return vec4(x,y,z,r);'
,'    }'
,'    vec4 hitPoint(vec4 V, vec4 sphere, vec4 screen_pixel) {'
,'        vec4 D = screen_pixel - V;' // Direction
,'        vec4 W = normalize(D);'     // Unit direction
,'        vec4 C = vec4(sphere.x, sphere.y, sphere.z, 1.0);'
,'        float r = sphere.w;'
,'        float e_B = dot((V-C), W);'
,'        float e_C = dot((V-C), (V-C))-r*r;'
,'        if (e_B*e_B - e_C >= 0.){'
,'          float t = e_B - sqrt(e_B*e_B - e_C);'
,'          vec4 hit_point = V + t*W;'
//,'          float dist = distance(V, hit_point);'
//,'          calc_lambert(hit_point, sphere, light);'
,'          return hit_point;'
,'        }else return vec4(100000., 100000., 100000., 0.);'
,'         '
,'    }'
,'    float normalLighing(vec4 surface_point, vec4 center, vec4 light){'
,'        if(surface_point.z == 0.){'
,'          return 0.;'
,'        }'
,'        vec4 surface_normal = normalize(center-surface_point);'
,'        float light_projection = max(0.0,(dot(surface_normal, light)));'
,'        return light_projection;'
,'    }'
,'    '
//,'    vec4 sphere2 = create_sphere('+s2x+', '+s2y+', -11., 5.);'
,'    float fl = 2.0;'
,'    vec4 background_color = vec4(0., 0.0, 0.0, 1.0);'
,'    '
,'    '
,'    void main() {'
,'        vec3 color = vec3(10,23,1);'
,'        vec4 sphere1 = create_sphere(0.,0., -5., 2.);'
,'        float x = v_pos.x;'
,'        float y = v_pos.y;'
,'        vec4 ray_origin = vec4(u_mouse.x/2., u_mouse.y/2., fl, 1.);'
,'        color *= (normalLighing(hitPoint(ray_origin, sphere1, vec4(x, y, 0, 1.0)), vec4(0.0,0.0,0.0,1.0), vec4(0.8,0.0,0.6,0.0)));'
,'        gl_FragColor = vec4(color, 1.0);'
// ,'        gl_FragColor = vec4(pow(color, vec3(.45,.45,.45)),1.0);'
,'    }'
].join('\n\ ');

// START GL PROGRAM

start_gl("canvas1", vertexShader, fragmentShader);

</script>
</body>